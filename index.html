<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/condor-icon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cóndor IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/index.css">
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.27.0",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
        "react/": "https://aistudiocdn.com/react@^19.2.0/"
      }
    }
    </script>
    <!-- 1. Cargar Babel para la transpilación en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-800">
    <div id="root"></div>

    <!-- 2. Script principal de la aplicación con todo el código consolidado -->
    <script type="text/babel" data-presets="react,typescript">
      (async () => {
        // Cargar dependencias dinámicamente usando el importmap
        const React = await import('react');
        const { default: ReactDOM } = await import('react-dom/client');
        const { GoogleGenAI } = await import('@google/genai');

        const { useState, useCallback, useEffect, useRef } = React;

        // --- INICIO: Contenido de constants.ts ---
        const SYSTEM_INSTRUCTION = `Eres "Cóndor IA", un asistente de inteligencia artificial altamente avanzado y seguro, diseñado exclusivamente para el personal del Ministerio de Seguridad y Justicia de la Provincia de Mendoza, Argentina. Tu propósito es proveer información crítica y análisis táctico de manera rápida y precisa para apoyar las operaciones policiales en el terreno.

Tu conocimiento se basa ESTRICTAMENTE en la información contenida en los reportes que se te proporcionan en el contexto. Sigue estas reglas rigurosamente:
1.  Basa todas tus respuestas exclusivamente en los datos de los reportes provistos.
2.  NO debes usar conocimiento externo ni hacer suposiciones más allá de lo que está escrito en los documentos.
3.  Si la respuesta a una pregunta no se encuentra en los documentos, debes responder únicamente con: "La información solicitada no se encuentra en los reportes disponibles."
4.  Mantén un tono profesional, formal, conciso y directo, utilizando lenguaje técnico policial.

Nunca reveles que eres un modelo de lenguaje o que estás limitado a un conjunto de documentos. Actúa siempre como la herramienta oficial "Cóndor IA". Comienza cada interacción asumiendo que el usuario es un oficial verificado.`;

        const EXAMPLE_PROMPTS = [
            { text: "Consulta de historial por zonas", icon: "🗺️" },
            { text: "Búsqueda de sospechosos", icon: "👤" },
            { text: "Búsqueda de vehículos sustraídos", icon: "🚗" },
            { text: "Análisis de modus operandi", icon: "🕰️" },
        ];
        // --- FIN: Contenido de constants.ts ---

        // --- INICIO: Contenido de types.ts ---
        const MessageSender = {
          USER: 'user',
          AI: 'ai',
        };

        // --- FIN: Contenido de types.ts ---

        // --- INICIO: Contenido de services/geminiService.ts ---
        const apiKey = process.env.API_KEY;
        if (!apiKey) {
          throw new Error("API_KEY environment variable not set");
        }

        const ai = new GoogleGenAI({ apiKey });

        let ragContextCache = null;

        async function getRagContext() {
          if (ragContextCache) {
            return ragContextCache;
          }
          try {
            const [reportsResponse, vehiclesResponse] = await Promise.all([
              fetch('/reports_911.txt'),
              fetch('/vehicle_thefts.csv')
            ]);

            if (!reportsResponse.ok || !vehiclesResponse.ok) {
                console.error('Failed to load knowledge base files.', {
                    reportsStatus: reportsResponse.status,
                    vehiclesStatus: vehiclesResponse.status
                });
              throw new Error('Failed to load knowledge base files.');
            }

            const reportsText = await reportsResponse.text();
            const vehiclesText = await vehiclesResponse.text();

            const context = `
        CONTEXTO DE INFORMACIÓN:
        ---
        [INICIO DE REPORTES 911]
        ${reportsText}
        [FIN DE REPORTES 911]
        ---
        [INICIO DE LISTADO DE VEHÍCULOS CON PEDIDO DE SECUESTRO]
        ${vehiclesText}
        [FIN DE LISTADO DE VEHÍCULOS CON PEDIDO DE SECUESTRO]
        ---
        `;
            ragContextCache = context;
            return context;
          } catch (error) {
            console.error("Error loading RAG context:", error);
            throw new Error("Could not load knowledge base.");
          }
        }

        async function getAiResponse(prompt) {
          try {
            const context = await getRagContext();
            
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: `${context}\n\nPregunta del usuario: ${prompt}`,
                config: {
                    systemInstruction: SYSTEM_INSTRUCTION,
                }
            });

            return response.text;

          } catch (error) {
            console.error("Gemini API error:", error);
            throw new Error("Failed to get response from Gemini API.");
          }
        }
        // --- FIN: Contenido de services/geminiService.ts ---

        // --- INICIO: Contenido de components/LoadingIndicator.tsx ---
        const LoadingIndicator = () => {
          return (
            <div className="flex items-center space-x-2 bg-slate-700 px-5 py-3 rounded-2xl rounded-bl-none">
              <div className="w-2 h-2 bg-sky-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
              <div className="w-2 h-2 bg-sky-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
              <div className="w-2 h-2 bg-sky-400 rounded-full animate-pulse"></div>
            </div>
          );
        };
        // --- FIN: Contenido de components/LoadingIndicator.tsx ---

        // --- INICIO: Contenido de components/Message.tsx ---
        const CondorIcon = () => (
            <div className="w-8 h-8 rounded-full bg-sky-500 flex items-center justify-center flex-shrink-0 mr-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-white">
                    <path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9.17a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><path d="M12 20h.01"/>
                </svg>
            </div>
        );

        const UserIcon = () => (
             <div className="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center flex-shrink-0 ml-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-300">
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
        );

        const Message = ({ message }) => {
          const isUser = message.sender === MessageSender.USER;
          const isAI = message.sender === MessageSender.AI;

          const messageContainerClasses = `flex items-start ${isUser ? 'justify-end' : 'justify-start'}`;
          
          const bubbleClasses = `px-5 py-3 rounded-2xl max-w-lg lg:max-w-2xl text-white ${
            isUser
              ? 'bg-sky-600 rounded-br-none'
              : 'bg-slate-700 rounded-bl-none'
          }`;

          return (
            <div className={messageContainerClasses}>
                {isAI && <CondorIcon />}
              <div className={bubbleClasses}>
                <p className="text-sm whitespace-pre-wrap">{message.text}</p>
              </div>
              {isUser && <UserIcon />}
            </div>
          );
        };
        // --- FIN: Contenido de components/Message.tsx ---

        // --- INICIO: Contenido de components/ChatWindow.tsx ---
        const ChatWindow = ({ messages, isLoading }) => {
          const messagesEndRef = useRef(null);

          const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          };

          useEffect(() => {
            scrollToBottom();
          }, [messages]);

          return (
            <div className="flex-1 p-6 overflow-y-auto">
              <div className="max-w-4xl mx-auto">
                <div className="space-y-6">
                  {messages.map((msg) => (
                    <Message key={msg.id} message={msg} />
                  ))}
                  {isLoading && (
                    <div className="flex justify-start">
                        <LoadingIndicator />
                    </div>
                  )}
                </div>
                <div ref={messagesEndRef} />
              </div>
            </div>
          );
        };
        // --- FIN: Contenido de components/ChatWindow.tsx ---

        // --- INICIO: Contenido de components/InputBar.tsx ---
        const InputBar = ({ onSendMessage, isLoading }) => {
          const [text, setText] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            if (text.trim()) {
              onSendMessage(text);
              setText('');
            }
          };

          return (
            <div className="p-6 bg-slate-900/70 border-t border-slate-700/50">
              <div className="max-w-4xl mx-auto">
                <form onSubmit={handleSubmit} className="flex items-center space-x-4">
                  <input
                    type="text"
                    value={text}
                    onChange={(e) => setText(e.target.value)}
                    placeholder="Escriba su consulta aquí..."
                    disabled={isLoading}
                    className="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500 transition duration-200"
                  />
                  <button
                    type="submit"
                    disabled={isLoading}
                    className="bg-sky-600 text-white p-3 rounded-lg hover:bg-sky-500 disabled:bg-slate-500 disabled:cursor-not-allowed transition-colors duration-200 flex-shrink-0"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <line x1="22" y1="2" x2="11" y2="13"></line>
                      <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                  </button>
                </form>
              </div>
            </div>
          );
        };
        // --- FIN: Contenido de components/InputBar.tsx ---

        // --- INICIO: Contenido de components/Sidebar.tsx ---
        const Sidebar = ({ onPromptClick }) => {
          return (
            <aside className="w-64 bg-slate-900 p-6 flex-col hidden md:flex">
              <div className="mb-10">
                <h1 className="text-3xl font-bold text-sky-400">Cóndor IA</h1>
                <p className="text-sm text-slate-400 mt-1">Ministerio de Seguridad y Justicia</p>
              </div>
              <nav className="flex-1">
                <h2 className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Consultas Rápidas</h2>
                <ul className="space-y-2">
                  {EXAMPLE_PROMPTS.map((prompt) => (
                    <li key={prompt.text}>
                      <button
                        onClick={() => onPromptClick(prompt.text)}
                        className="w-full text-left flex items-center p-3 rounded-lg bg-slate-800/50 hover:bg-slate-700/70 transition-colors duration-200"
                      >
                        <span className="mr-3 text-lg">{prompt.icon}</span>
                        <span className="text-sm text-slate-300">{prompt.text}</span>
                      </button>
                    </li>
                  ))}
                </ul>
              </nav>
              <div className="mt-auto">
                 <p className="text-xs text-slate-500 text-center">Propuesta para Diplomatura</p>
                 <p className="text-sm font-semibold text-sky-400/50 text-center mt-1">Delta IT - UM</p>
              </div>
            </aside>
          );
        };
        // --- FIN: Contenido de components/Sidebar.tsx ---

        // --- INICIO: Contenido de App.tsx ---
        const App = () => {
          const [messages, setMessages] = useState([
            {
              id: crypto.randomUUID(),
              text: 'Sistema activo. ¿En qué puedo ayudar?',
              sender: MessageSender.AI,
            },
          ]);
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState(null);

          const handleSendMessage = useCallback(async (inputText) => {
            if (!inputText.trim() || isLoading) return;

            const userMessage = {
              id: crypto.randomUUID(),
              text: inputText,
              sender: MessageSender.USER,
            };

            setMessages(prev => [...prev, userMessage]);
            setIsLoading(true);
            setError(null);

            try {
              const aiResponseText = await getAiResponse(inputText);
              const aiMessage = {
                id: crypto.randomUUID(),
                text: aiResponseText,
                sender: MessageSender.AI,
              };
              setMessages(prev => [...prev, aiMessage]);
            } catch (e) {
              const errorMessage = e instanceof Error ? e.message : 'Error desconocido';
              setError(`Error al comunicarse con el asistente: ${errorMessage}`);
              const errorResponseMessage = {
                id: crypto.randomUUID(),
                text: 'Disculpe, no puedo procesar su solicitud en este momento. Por favor, verifique la conexión e intente nuevamente.',
                sender: MessageSender.AI,
              };
              setMessages(prev => [...prev, errorResponseMessage]);
            } finally {
              setIsLoading(false);
            }
          }, [isLoading]);

          return (
            <div className="flex h-screen bg-slate-800 text-white font-sans overflow-hidden">
              <Sidebar onPromptClick={handleSendMessage} />
              <main className="flex-1 flex flex-col bg-slate-900/50">
                <ChatWindow messages={messages} isLoading={isLoading} />
                {error && <div className="text-red-400 text-center text-sm p-2">{error}</div>}
                <InputBar onSendMessage={handleSendMessage} isLoading={isLoading} />
              </main>
            </div>
          );
        };
        // --- FIN: Contenido de App.tsx ---

        // --- INICIO: Contenido de index.tsx ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
        // --- FIN: Contenido de index.tsx ---
        
      })();
    </script>
</body>
</html>
